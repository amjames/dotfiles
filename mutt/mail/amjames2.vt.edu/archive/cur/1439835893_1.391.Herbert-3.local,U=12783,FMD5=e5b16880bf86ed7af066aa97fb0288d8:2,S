Delivered-To: amjames2@vt.edu
Received: by 10.140.25.151 with SMTP id 23csp1157052qgt;
        Thu, 13 Aug 2015 14:38:38 -0700 (PDT)
X-Received: by 10.140.237.135 with SMTP id i129mr35085256qhc.32.1439501918094;
        Thu, 13 Aug 2015 14:38:38 -0700 (PDT)
Return-Path: <bounces+848413-3e11-amjames2=vt.edu@sgmail.github.com>
Received: from mr1.cc.vt.edu (mr1.cc.ipv6.vt.edu. [2001:468:c80:2105:0:277:40de:506c])
        by mx.google.com with ESMTPS id i83si6013347qkh.41.2015.08.13.14.38.37
        for <amjames2@vt.edu>
        (version=TLSv1.2 cipher=ECDHE-RSA-AES128-GCM-SHA256 bits=128/128);
        Thu, 13 Aug 2015 14:38:38 -0700 (PDT)
Received-SPF: pass (google.com: best guess record for domain of bounces+848413-3e11-amjames2=vt.edu@sgmail.github.com designates 192.254.113.10 as permitted sender) client-ip=192.254.113.10;
Authentication-Results: mx.google.com;
       spf=pass (google.com: best guess record for domain of bounces+848413-3e11-amjames2=vt.edu@sgmail.github.com designates 192.254.113.10 as permitted sender) smtp.mailfrom=bounces+848413-3e11-amjames2=vt.edu@sgmail.github.com;
       dkim=pass header.i=@github.com
Received: from o5.sgmail.github.com (o5.sgmail.github.com [192.254.113.10])
	by mr1.cc.vt.edu (8.14.7/8.14.7) with ESMTP id t7DLcUGe009573
	for <amjames2@vt.edu>; Thu, 13 Aug 2015 17:38:36 -0400
DKIM-Signature: v=1; a=rsa-sha1; c=relaxed; d=github.com; 
	h=from:reply-to:to:in-reply-to:references:subject:mime-version:content-type:content-transfer-encoding:list-id:list-archive:list-post:list-unsubscribe; 
	s=s20150108; bh=aK7KG7EGqGj0IQLRERbRyJ7dpqo=; b=NqmTHpI3iI3ACxS/
	cNSvxyo/76qtVGULF0JdQvjGv/mkFWxapWyS6HedNDLZOL+ECRDNbBYvwaqiUNlB
	GSt2W5uHkYG1A/UlJ+VRbZFIxHZanj8i/G1oIelBhpfaIGJ730clLMUJDx245Pgu
	uQWO1IXq4QdSpyq3AO+ULaooK3Q=
Received: by filter0853p1mdw1.sendgrid.net with SMTP id filter0853p1mdw1.16751.55CD0E5531
        2015-08-13 21:38:29.784650204 +0000 UTC
Received: from github-smtp2b-ext-cp1-prd.iad.github.net (github-smtp2b-ext-cp1-prd.iad.github.net [192.30.253.17])
	by ismtpd0002p1iad1.sendgrid.net (SG) with ESMTP id F3vswq9cRte14IHJi9IjBA
	for <amjames2@vt.edu>; Thu, 13 Aug 2015 21:38:29 +0000 (UTC)
Date: Thu, 13 Aug 2015 14:38:27 -0700
From: Rob Parrish <notifications@github.com>
Reply-To: psi4/psi4public <reply+0089f6424c87537e8083cc2c6bbd8080747a4edd6a2f11d792cf0000000111e4d05392a169ce05acd8a9@reply.github.com>
To: psi4/psi4public <psi4public@noreply.github.com>
Message-ID: <psi4/psi4public/issues/119/130852343@github.com>
In-Reply-To: <psi4/psi4public/issues/119@github.com>
References: <psi4/psi4public/issues/119@github.com>
Subject: Re: [psi4public] DF-MP2 crashes if given more than 30GB of memory
 (maybe) (#119)
Mime-Version: 1.0
Content-Type: multipart/alternative;
 boundary="--==_mimepart_55cd0e53916c9_41eb3fcf247cf2bc112985";
 charset=UTF-8
Content-Transfer-Encoding: 7bit
Precedence: list
X-GitHub-Sender: robparrish
X-GitHub-Recipient: amjames
List-ID: psi4/psi4public <psi4public.psi4.github.com>
List-Archive: https://github.com/psi4/psi4public
List-Post: <mailto:reply+0089f6424c87537e8083cc2c6bbd8080747a4edd6a2f11d792cf0000000111e4d05392a169ce05acd8a9@reply.github.com>
List-Unsubscribe: <mailto:unsub+0089f6424c87537e8083cc2c6bbd8080747a4edd6a2f11d792cf0000000111e4d05392a169ce05acd8a9@reply.github.com>,
 <https://github.com/notifications/unsubscribe/AIn2Qnp_5c7dibnesKL09rAEEJ5BF1QQks5onQXTgaJpZM4FZIa->
X-Auto-Response-Suppress: All
X-GitHub-Recipient-Address: amjames2@vt.edu
X-SG-EID: UJLDIEm0+sbiS+3uuNJpMWQdL8kmmWJ29I1nvY4W5IkpXz2whvhFmIcIboEhWpXFWYQ9HH+dLDHz6e
 W1IBzwfgui5HWg+vZzFqFeCpnY791Gozv492n8G8Q+STPt9wZ2krPzaveMHv0dMvM5PksuIcroKj6C
 7yxKuBdTVP5hxlM=
X-Spam-Status: No, score=-0.1 required=5.0 tests=DKIM_SIGNED,DKIM_VALID,
	DKIM_VALID_AU,HTML_IMAGE_ONLY_32,HTML_MESSAGE,RP_MATCHES_RCVD
	autolearn=disabled version=3.4.0
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on mr1.cc.vt.edu
X-Gm-Spam: 0
X-Gm-Phishy: 0
X-Gm-Spam: 0
X-Gm-Phishy: 0

----==_mimepart_55cd0e53916c9_41eb3fcf247cf2bc112985
Content-Type: text/plain;
 charset=UTF-8
Content-Transfer-Encoding: 7bit

Working Notes:

PSI4: Git: Rev {master} ad9c3d9
Config: RHEL/icpc/MKL/Debug
Hardware: i7x6, 64GB, 2TB

Running with GDB:

30 GB/12 threads - passes, max memory ~27 GB, ~25 mins
40 GB/12 threads - Segfault! 

Source:

Program received signal SIGSEGV, Segmentation fault.
0x00007ffff1293cad in __memset_sse2 () from /lib64/libc.so.6
(gdb) bt
#0  0x00007ffff1293cad in __memset_sse2 () from /lib64/libc.so.6
#1  0x0000000003529efb in psi::Matrix::zero (this=0xe7b9350)
    at /theoryfs2/ds/parrish/psi4public/src/lib/libmints/matrix.cc:1002
#2  0x0000000001bc54f7 in psi::dfmp2::RDFMP2::form_L (this=0xeb31d30)
    at /theoryfs2/ds/parrish/psi4public/src/bin/dfmp2/mp2.cc:1912

mp2.cc:1912 zeros Gmn, a three-center tensor which is currently 1896 x 1086^2 = 2236134816, which as we all know is just above 2^31 - 1 = 2147483647. So I suspect:

frame 1
#1  0x0000000003529efb in psi::Matrix::zero (this=0xe7b9350)
    at /theoryfs2/ds/parrish/psi4public/src/lib/libmints/matrix.cc:1002
1002	            memset(&(matrix_[h][0][0]), 0, size);
(gdb) print size
$1 = 18446744057257762112

Yep, matrix zero is FUBAR. The offending line is matrix.cc:999:

        size = rowspi_[h] * colspi_[h^symmetry_] * sizeof(double);

Changed to:

        size = rowspi_[h] * ((size_t) colspi_[h^symmetry_]) * sizeof(double);

Ed and I once worked out that casting to size_t works properly if the left-most element in a chain of integer multiplies is size_t. But I don't completely trust that, and so often do all work in size_t. I'll close if working in another half hour.

---
Reply to this email directly or view it on GitHub:
https://github.com/psi4/psi4public/issues/119#issuecomment-130852343
----==_mimepart_55cd0e53916c9_41eb3fcf247cf2bc112985
Content-Type: text/html;
 charset=UTF-8
Content-Transfer-Encoding: 7bit

<p>Working Notes:</p>

<p>PSI4: Git: Rev {master} <a href="https://github.com/psi4/psi4public/commit/ad9c3d97dc95c9e5d8f629bb9e9afba06463e607" class="commit-link"><tt>ad9c3d9</tt></a><br>
Config: RHEL/icpc/MKL/Debug<br>
Hardware: i7x6, 64GB, 2TB</p>

<p>Running with GDB:</p>

<p>30 GB/12 threads - passes, max memory ~27 GB, ~25 mins<br>
40 GB/12 threads - Segfault! </p>

<p>Source:</p>

<p>Program received signal SIGSEGV, Segmentation fault.<br>
0x00007ffff1293cad in __memset_sse2 () from /lib64/libc.so.6<br>
(gdb) bt<br>
#0  0x00007ffff1293cad in __memset_sse2 () from /lib64/libc.so.6<br>
<a href="https://github.com/psi4/psi4public/issues/1" class="issue-link" title="CASSCF module not ported yet">#1</a>  0x0000000003529efb in psi::Matrix::zero (this=0xe7b9350)<br>
    at /theoryfs2/ds/parrish/psi4public/src/lib/libmints/matrix.cc:1002<br>
<a href="https://github.com/psi4/psi4public/issues/2" class="issue-link" title="Need to specify license">#2</a>  0x0000000001bc54f7 in psi::dfmp2::RDFMP2::form_L (this=0xeb31d30)<br>
    at /theoryfs2/ds/parrish/psi4public/src/bin/dfmp2/mp2.cc:1912</p>

<p>mp2.cc:1912 zeros Gmn, a three-center tensor which is currently 1896 x 1086^2 = 2236134816, which as we all know is just above 2^31 - 1 = 2147483647. So I suspect:</p>

<p>frame 1<br>
<a href="https://github.com/psi4/psi4public/issues/1" class="issue-link" title="CASSCF module not ported yet">#1</a>  0x0000000003529efb in psi::Matrix::zero (this=0xe7b9350)<br>
    at /theoryfs2/ds/parrish/psi4public/src/lib/libmints/matrix.cc:1002<br>
1002                memset(&amp;(matrix_[h][0][0]), 0, size);<br>
(gdb) print size<br>
$1 = 18446744057257762112</p>

<p>Yep, matrix zero is FUBAR. The offending line is matrix.cc:999:</p>

<pre><code>    size = rowspi_[h] * colspi_[h^symmetry_] * sizeof(double);
</code></pre>

<p>Changed to:</p>

<pre><code>    size = rowspi_[h] * ((size_t) colspi_[h^symmetry_]) * sizeof(double);
</code></pre>

<p>Ed and I once worked out that casting to size_t works properly if the left-most element in a chain of integer multiplies is size_t. But I don't completely trust that, and so often do all work in size_t. I'll close if working in another half hour.</p>

<p style="font-size:small;-webkit-text-size-adjust:none;color:#666;">&mdash;<br>Reply to this email directly or <a href="https://github.com/psi4/psi4public/issues/119#issuecomment-130852343">view it on GitHub</a>.<img alt="" height="1" src="https://github.com/notifications/beacon/AIn2Qu2U_ukM-ySie2TLRahfhySW0AcXks5onQXTgaJpZM4FZIa-.gif" width="1" /></p>
<div itemscope itemtype="http://schema.org/EmailMessage">
<div itemprop="action" itemscope itemtype="http://schema.org/ViewAction">
  <link itemprop="url" href="https://github.com/psi4/psi4public/issues/119#issuecomment-130852343"></link>
  <meta itemprop="name" content="View Issue"></meta>
</div>
<meta itemprop="description" content="View this Issue on GitHub"></meta>
</div>

----==_mimepart_55cd0e53916c9_41eb3fcf247cf2bc112985--
