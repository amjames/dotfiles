Delivered-To: amjames2@vt.edu
Received: by 10.140.25.151 with SMTP id 23csp103568qgt;
        Fri, 14 Aug 2015 20:33:29 -0700 (PDT)
X-Received: by 10.55.50.74 with SMTP id y71mr73914658qky.52.1439609609791;
        Fri, 14 Aug 2015 20:33:29 -0700 (PDT)
Return-Path: <andrew.m.james2+caf_=amjames2=vt.edu@gmail.com>
Received: from mr6.cc.vt.edu (mr6.cc.ipv6.vt.edu. [2001:468:c80:2105:0:250:3bcb:5b17])
        by mx.google.com with ESMTPS id 62si13347593qht.63.2015.08.14.20.33.29
        for <amjames2@vt.edu>
        (version=TLSv1.2 cipher=ECDHE-RSA-AES128-GCM-SHA256 bits=128/128);
        Fri, 14 Aug 2015 20:33:29 -0700 (PDT)
Received-SPF: pass (google.com: domain of andrew.m.james2+caf_=amjames2=vt.edu@gmail.com designates 209.85.223.182 as permitted sender) client-ip=209.85.223.182;
Authentication-Results: mx.google.com;
       spf=pass (google.com: domain of andrew.m.james2+caf_=amjames2=vt.edu@gmail.com designates 209.85.223.182 as permitted sender) smtp.mailfrom=andrew.m.james2+caf_=amjames2=vt.edu@gmail.com
Received: from mail-io0-f182.google.com (mail-io0-f182.google.com [209.85.223.182])
	by mr6.cc.vt.edu (8.14.4/8.14.4) with ESMTP id t7F3XNMY028847
	for <amjames2@vt.edu>; Fri, 14 Aug 2015 23:33:28 -0400
Received: by iods203 with SMTP id s203so103590941iod.0
        for <amjames2@vt.edu>; Fri, 14 Aug 2015 20:33:23 -0700 (PDT)
X-Received: by 10.107.152.148 with SMTP id a142mr16241413ioe.149.1439609603567;
        Fri, 14 Aug 2015 20:33:23 -0700 (PDT)
X-Forwarded-To: amjames2@vt.edu
X-Forwarded-For: andrew.m.james2@gmail.com amjames2@vt.edu
Delivered-To: andrew.m.james2@gmail.com
Received: by 10.64.19.209 with SMTP id h17csp82420iee;
        Fri, 14 Aug 2015 20:33:21 -0700 (PDT)
X-Received: by 10.140.147.69 with SMTP id 66mr90690281qht.57.1439609601277;
        Fri, 14 Aug 2015 20:33:21 -0700 (PDT)
Received: from omr1.cc.vt.edu (omr1.cc.ipv6.vt.edu. [2607:b400:92:8300:0:c6:2117:b0e])
        by mx.google.com with ESMTPS id r16si7035504qkl.69.2015.08.14.20.33.20
        for <andrew.m.james2@gmail.com>
        (version=TLSv1.2 cipher=ECDHE-RSA-AES128-GCM-SHA256 bits=128/128);
        Fri, 14 Aug 2015 20:33:21 -0700 (PDT)
Received-SPF: pass (google.com: domain of crawdad@vt.edu designates 2607:b400:92:8300:0:c6:2117:b0e as permitted sender) client-ip=2607:b400:92:8300:0:c6:2117:b0e;
Received: from mr4.cc.vt.edu (mr4.cc.ipv6.vt.edu [IPv6:2001:468:c80:2105:0:232:8670:19fe])
	by omr1.cc.vt.edu (8.14.4/8.14.4) with ESMTP id t7F3XKPM025944
	for <andrew.m.james2@gmail.com>; Fri, 14 Aug 2015 23:33:20 -0400
Received: from mail-io0-f169.google.com (mail-io0-f169.google.com [209.85.223.169])
	by mr4.cc.vt.edu (8.14.4/8.14.4) with ESMTP id t7F3XF7H018170
	for <andrew.m.james2@gmail.com>; Fri, 14 Aug 2015 23:33:20 -0400
Received: by iodt126 with SMTP id t126so103856503iod.2
        for <andrew.m.james2@gmail.com>; Fri, 14 Aug 2015 20:33:15 -0700 (PDT)
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20130820;
        h=x-gm-message-state:mime-version:in-reply-to:references:date
         :message-id:subject:from:to:cc:content-type;
        bh=wHRimNHspyqOxtrPi+BGR/9JpifZrwPWR7HCiEw1kAg=;
        b=XbrzMTiQ5jf4TK0qTahqhOMnn7D2GR8aC3G9URj9adzsoBwka0ya5uwUF2dx0M6pFT
         09NIGAqlER0HGeL21Nb40MB7faqRD1AcIhT7ENvr0HTuWOAKYuI3zXbb+TPXgZj+Lzd+
         FK2TeyI5N4fw8lrtlRqOCgKE3GQ1WWVbgpVKObAvVk2f8h+PyxdpZ36C9unEkO9ctVgZ
         waAcAF4C33mpkh895VTTaGg4KFwawQtSZC+/1uHt4jPidUKjcrIraIf02xbMM97ZvdtZ
         rFDOtC8PRUw8UOk1MlVU/pYoc8DEp0cpBnw0l+Mka3CesxMzdX8re8tkNmmYvb0T8hLw
         fhBA==
X-Gm-Message-State: ALoCoQls91sfguYD7Pu1kHsZkNbb8DDuymdmWDovKqmC2vYhe2cEoFD9C5aDCfHTCYKeF5uG4znC4b6mIy8in6LrwK+dH2I9iFEG7vy8JwgcM4ZvNTAA+EnH2lB88dplnDt1xuaKQIw5Wb81FPl11dXNCd1hIw8krg==
X-Received: by 10.107.5.149 with SMTP id 143mr56293283iof.109.1439609594990;
        Fri, 14 Aug 2015 20:33:14 -0700 (PDT)
MIME-Version: 1.0
X-Received: by 10.107.5.149 with SMTP id 143mr56293258iof.109.1439609594732;
 Fri, 14 Aug 2015 20:33:14 -0700 (PDT)
Received: by 10.107.55.87 with HTTP; Fri, 14 Aug 2015 20:33:14 -0700 (PDT)
In-Reply-To: <DM2PR0701MB1135CC5A65AFC9F517CF4289C4700@DM2PR0701MB1135.namprd07.prod.outlook.com>
References: <CAH0V_1bgjCVJcr5KjGLML2PrHWnki0oDkd4P-6KhC0MD6Y1ZPg@mail.gmail.com>
	<CAH0V_1Ze7-5Ep8CL+4EwG_vhyouVid+w12rDSDzDPPpV4ao9tQ@mail.gmail.com>
	<DM2PR0701MB1135CC5A65AFC9F517CF4289C4700@DM2PR0701MB1135.namprd07.prod.outlook.com>
Date: Fri, 14 Aug 2015 23:33:14 -0400
Message-ID: <CAH0V_1aW8Sg6cHDZGB2r5hX+DD=qUZn-qheg=D_U8NcEaAjwRg@mail.gmail.com>
Subject: Re: UHF Stability Code Again
From: "T. Daniel Crawford" <crawdad@vt.edu>
To: "Gonthier, Jerome F" <jerome.gonthier@chemistry.gatech.edu>
Cc: Andrew James <andrew.m.james2@gmail.com>,
        Andy Simmonett <andy.simmonett@gmail.com>
Content-Type: multipart/alternative; boundary=001a113eecee827c96051d513ac1
X-Spam-Status: No, score=-0.7 required=5.0 tests=HTML_MESSAGE,
	RCVD_IN_DNSWL_LOW autolearn=disabled version=3.3.1
X-Spam-Checker-Version: SpamAssassin 3.3.1 (2010-03-16) on mr6.cc.vt.edu
X-Gm-Spam: 0
X-Gm-Phishy: 0
X-Gm-Spam: 0
X-Gm-Phishy: 0

--001a113eecee827c96051d513ac1
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: quoted-printable

Hi, Jerome,

Thanks for the feedback. I continue to have trouble getting through a
stability_check() + CCSD energy, which leads me to think that there are two
primary problems is the stability code right now:

(1) If the ultimate calculation requested by the user is a correlated wfn
like CCSD, then the stability check requires not only the PK integrals, but
also an explicit transformation. That is, the code will first converge the
DF-SCF MOs, then compute the PK integrals, then carry out the
transformation, rotate the MOs, check the MO Hessian, converge a new SCF,
carry out a new transformation, and then check the MO Hessian.  After this,
the code will carry out another transformation via transqt2, which seems a
complete waste.  G09 blows us away on the stability thing by at least a
factor of 10 right now.

(2) In my opinion there's a structural problem in that the
stability_analysis() code implicitly becomes the SCF driver until a stable
wave function has been found.  A simple practical implication of this is
that the HF::finalize() function, which builds the final Lagrangian and
releases some memory, gets called twice.  But this seems to be more of a
design flaw to me in that the stability_analysis() should not be in charge
=E2=80=93 i.e., it should call compute_energy().  In my opinion, either con=
trol
over the sequence needs to be at the Python level or within the scf::main()
C++ level.

I welcome your thoughts on this.  (I've copied Andy, as well, because he
and I had an email back-and-forth on this last week.)

Best regards,

-TDC

--
Prof. T. Daniel Crawford
crawdad@vt.edu

On Mon, Aug 10, 2015 at 3:22 PM, Gonthier, Jerome F <
jerome.gonthier@chemistry.gatech.edu> wrote:

> Hi Daniel,
>
>
> so, I misunderstood you and I thought that the SCF had convergence
> problems, and not the DLU solver. I think the best keyword for the DLU
> solver is
>
>
> solver_max_subspace
>
>
> the default is at 6, I think... It may be too low, I am still playing wit=
h
> the parameters a bit. Setting it to 12 converges the 2 lowest roots.
> Setting it to 20 will further decrease the number of iterations, but
> iterations with a large subspace cost more.
>
>
> With your test case, solver_max_subspace 12 converges in 88 iterations. I
> may set the default at one root only, it should not be a problem as long =
as
> several guess vectors are used, which is the default. (If not, the solver
> could get stuck on a higher root).
>
>
> For the CC question, it would be helpful to see your input file. Do you
> specify scf_type ? If not, I'm afraid PSI4 defaults to DF for the scf, an=
d
> to PK for CC. So if you have:
>
>
> energy('scf') <- this is going to use DF
>
>
> energy('ccsd') <- this is going to use PK, and to redo an SCF before the
> CC computation.
>
>
> Does this help ?
>
>
> Thanks again for being a de facto tester of my code. I am currently tryin=
g
> to finish the documentation, which will probably help.
>
>
> Cheers,
>
>
> J=C3=A9r=C3=B4me
>
>
> ------------------------------
> *From:* T. Daniel Crawford <crawdad@vt.edu>
> *Sent:* Thursday, August 6, 2015 1:27 PM
> *To:* Gonthier, Jerome F
> *Cc:* Andrew James
> *Subject:* Re: UHF Stability Code Again
>
> Hi, Jerome,
>
> I can get convergence if I set solver_n_root =3D 1 (since I really only w=
ant
> the lowest root anyway).  I wonder if such tight default convergence
> (10^-6) is necessary for most stability analyses?
>
> However, I have another question about UHF stability analysis when couple=
d
> to subsequent CC calculations.  Why does the stability code switch over t=
o
> PK integrals in such cases?  The SCF code runs DF-UHF to get a good guess=
,
> then computes and stores the JK integrals to solve the UHF equations.  Th=
en
> the stability code calls the PK integral algorithm (including
> transformation) to do its analysis.  Do correlated calculations following
> stability analysis require the PK-based stability algorithm?
>
> -TDC
>
>
>
> --
> Prof. T. Daniel Crawford
> crawdad@vt.edu
>
> On Thu, Aug 6, 2015 at 10:55 AM, T. Daniel Crawford <crawdad@vt.edu>
> wrote:
>
>> Hi, Jerome,
>>
>> I thought that everything was working with the UHF stability code, but i=
t
>> seems there are still convergence problems.  Can you take a look at the
>> attached test case and give me suggestions for parameters to get it to
>> converge on the second pass?
>>
>> Thanks!
>>
>> -TDC
>> --
>> Prof. T. Daniel Crawford
>> crawdad@vt.edu
>>
>
>

--001a113eecee827c96051d513ac1
Content-Type: text/html; charset=UTF-8
Content-Transfer-Encoding: quoted-printable

<div dir=3D"ltr">Hi, Jerome,<div><br></div><div>Thanks for the feedback. I =
continue to have trouble getting through a stability_check() + CCSD energy,=
 which leads me to think that there are two primary problems is the stabili=
ty code right now:</div><div><br></div><div>(1) If the ultimate calculation=
 requested by the user is a correlated wfn like CCSD, then the stability ch=
eck requires not only the PK integrals, but also an explicit transformation=
. That is, the code will first converge the DF-SCF MOs, then compute the PK=
 integrals, then carry out the transformation, rotate the MOs, check the MO=
 Hessian, converge a new SCF, carry out a new transformation, and then chec=
k the MO Hessian.=C2=A0 After this, the code will carry out another transfo=
rmation via transqt2, which seems a complete waste.=C2=A0 G09 blows us away=
 on the stability thing by at least a factor of 10 right now.</div><div><br=
></div><div>(2) In my opinion there&#39;s a structural problem in that the =
stability_analysis() code implicitly becomes the SCF driver until a stable =
wave function has been found.=C2=A0 A simple practical implication of this =
is that the HF::finalize() function, which builds the final Lagrangian and =
releases some memory, gets called twice.=C2=A0 But this seems to be more of=
 a design flaw to me in that the stability_analysis() should not be in char=
ge =E2=80=93 i.e., it should call compute_energy().=C2=A0 In my opinion, ei=
ther control over the sequence needs to be at the Python level or within th=
e scf::main() C++ level.</div><div><br></div><div>I welcome your thoughts o=
n this. =C2=A0(I&#39;ve copied Andy, as well, because he and I had an email=
 back-and-forth on this last week.)</div><div><br></div><div>Best regards,<=
/div><div><br></div><div>-TDC</div></div><div class=3D"gmail_extra"><br cle=
ar=3D"all"><div><div class=3D"gmail_signature"><div dir=3D"ltr">--<div>Prof=
. T. Daniel Crawford</div><div><a href=3D"mailto:crawdad@vt.edu" target=3D"=
_blank">crawdad@vt.edu</a></div></div></div></div>
<br><div class=3D"gmail_quote">On Mon, Aug 10, 2015 at 3:22 PM, Gonthier, J=
erome F <span dir=3D"ltr">&lt;<a href=3D"mailto:jerome.gonthier@chemistry.g=
atech.edu" target=3D"_blank">jerome.gonthier@chemistry.gatech.edu</a>&gt;</=
span> wrote:<br><blockquote class=3D"gmail_quote" style=3D"margin:0 0 0 .8e=
x;border-left:1px #ccc solid;padding-left:1ex">




<div dir=3D"ltr">
<div style=3D"font-size:12pt;color:#000000;background-color:#ffffff;font-fa=
mily:Calibri,Arial,Helvetica,sans-serif">
<p>Hi Daniel,</p>
<p><br>
</p>
<p>so, I misunderstood you and I thought that the SCF had convergence probl=
ems, and not the DLU solver. I think the best keyword for the DLU solver is=
</p>
<p><br>
</p>
<p>solver_max_subspace=C2=A0</p>
<p><br>
</p>
<p>the default is at 6, I think... It may be too low, I am still playing wi=
th the parameters a bit. Setting it to 12 converges the 2 lowest roots. Set=
ting it to 20 will further decrease the number of iterations, but iteration=
s with a large subspace cost more.</p>
<p><br>
</p>
<p>With your test case, solver_max_subspace 12 converges in 88 iterations. =
I may set the default at one root only, it should not be a problem as long =
as several guess vectors are used, which is the default. (If not, the solve=
r could get stuck on a higher root).</p>
<p><br>
</p>
<p>For the CC question, it would be helpful to see your input file. Do you =
specify scf_type ? If not, I&#39;m afraid PSI4 defaults to DF for the scf, =
and to PK for CC. So if you have:</p>
<p><br>
</p>
<p>energy(&#39;scf&#39;) &lt;- this is going to use DF</p>
<p><br>
</p>
<p>energy(&#39;ccsd&#39;) &lt;- this is going to use PK, and to redo an SCF=
 before the CC computation.</p>
<p><br>
</p>
<p>Does this help ?</p>
<p><br>
</p>
<p>Thanks again for being a de facto tester of my code. I am currently tryi=
ng to finish the documentation, which will probably help.</p>
<p><br>
</p>
<p>Cheers,</p>
<p><br>
</p>
<p>J=C3=A9r=C3=B4me<br>
</p>
<br>
<br>
<div style=3D"color:rgb(24,22,21)"><span class=3D"">
<hr style=3D"display:inline-block;width:98%">
<div dir=3D"ltr"><font style=3D"font-size:11pt" color=3D"#000000" face=3D"C=
alibri, sans-serif"><b>From:</b> T. Daniel Crawford &lt;<a href=3D"mailto:c=
rawdad@vt.edu" target=3D"_blank">crawdad@vt.edu</a>&gt;<br>
<b>Sent:</b> Thursday, August 6, 2015 1:27 PM<br>
<b>To:</b> Gonthier, Jerome F<br>
<b>Cc:</b> Andrew James<br>
<b>Subject:</b> Re: UHF Stability Code Again</font>
<div>=C2=A0</div>
</div>
</span><div><div class=3D"h5"><div>
<div dir=3D"ltr">Hi, Jerome,
<div><br>
</div>
<div>I can get convergence if I set solver_n_root =3D 1 (since I really onl=
y want the lowest root anyway).=C2=A0 I wonder if such tight default conver=
gence (10^-6) is necessary for most stability analyses? =C2=A0</div>
<div><br>
</div>
<div>However, I have another question about UHF stability analysis when cou=
pled to subsequent CC calculations.=C2=A0 Why does the stability code switc=
h over to PK integrals in such cases?=C2=A0 The SCF code runs DF-UHF to get=
 a good guess, then computes and stores the
 JK integrals to solve the UHF equations.=C2=A0 Then the stability code cal=
ls the PK integral algorithm (including transformation) to do its analysis.=
=C2=A0 Do correlated calculations following stability analysis require the =
PK-based stability algorithm?</div>
<div><br>
</div>
<div>-TDC</div>
<div><br>
</div>
<div><br>
</div>
</div>
<div class=3D"gmail_extra"><br clear=3D"all">
<div>
<div>
<div dir=3D"ltr">--
<div>Prof. T. Daniel Crawford</div>
<div><a href=3D"mailto:crawdad@vt.edu" target=3D"_blank">crawdad@vt.edu</a>=
</div>
</div>
</div>
</div>
<br>
<div class=3D"gmail_quote">On Thu, Aug 6, 2015 at 10:55 AM, T. Daniel Crawf=
ord <span dir=3D"ltr">
&lt;<a href=3D"mailto:crawdad@vt.edu" target=3D"_blank">crawdad@vt.edu</a>&=
gt;</span> wrote:<br>
<blockquote class=3D"gmail_quote" style=3D"margin:0 0 0 .8ex;border-left:1p=
x #ccc solid;padding-left:1ex">
<div dir=3D"ltr">Hi, Jerome,
<div><br>
</div>
<div>I thought that everything was working with the UHF stability code, but=
 it seems there are still convergence problems.=C2=A0 Can you take a look a=
t the attached test case and give me suggestions for parameters to get it t=
o converge on the second pass?</div>
<div><br>
</div>
<div>Thanks!</div>
<div><br>
</div>
<div>-TDC<br clear=3D"all">
<div>
<div>
<div dir=3D"ltr">--
<div>Prof. T. Daniel Crawford</div>
<div><a href=3D"mailto:crawdad@vt.edu" target=3D"_blank">crawdad@vt.edu</a>=
</div>
</div>
</div>
</div>
</div>
</div>
</blockquote>
</div>
<br>
</div>
</div>
</div></div></div>
</div>
</div>

</blockquote></div><br></div>

--001a113eecee827c96051d513ac1--
